services:
  relay:
    build:
      context: .
      dockerfile: swarm/Dockerfile
    container_name: swarm_combined
    ports:
      - "3334:3334"  # Single port for both relay and frontend
    environment:
      # Relay configuration
      RELAY_NAME: ${RELAY_NAME:-Swarm Relay with Nostr-CMS}
      RELAY_PUBKEY: ${RELAY_PUBKEY}
      RELAY_DESCRIPTION: ${RELAY_DESCRIPTION:-Nostr Relay + CMS Combined}
      RELAY_PORT: "3334"
      DB_ENGINE: ${DB_ENGINE:-badger}
      DB_PATH: /app/db/

      # Frontend configuration (COMBINED MODE)
      SERVE_FRONTEND: "true"
      FRONTEND_BASE_PATH: "/"
      ENABLE_FRONTEND_AUTH: "false"  # Public view, auth only for admin actions

      # Nostr.json configuration (local vs remote)
      NOSTR_JSON_MODE: ${NOSTR_JSON_MODE:-local}  # "local" or "remote"

      # Frontend environment variables (injected into frontend)
      VITE_DEFAULT_RELAY: ${VITE_DEFAULT_RELAY:-ws://localhost:3334}
      VITE_REMOTE_NOSTR_JSON_URL: ${VITE_REMOTE_NOSTR_JSON_URL:-}
      VITE_MASTER_PUBKEY: ${VITE_MASTER_PUBKEY:-}

      # Blossom configuration (Nostr-CMS has built-in media upload)
      BLOSSOM_ENABLED: ${BLOSSOM_ENABLED:-true}  # Enable for Nostr-CMS media
      BLOSSOM_PATH: ${BLOSSOM_PATH:-blossom/}
      BLOSSOM_URL: ${BLOSSOM_URL:-http://localhost:3334}
    volumes:
      - public_data:/app/public
      - badger_data:/app/db
      - blossom_data:/app/blossom
      - backup_data:/app/backups
    labels:
      zeabur.service.name: "swarm-combined"
      zeabur.service.type: "docker"
      zeabur.service.port: "3334"

volumes:
  badger_data:
  blossom_data:
  backup_data:
  public_data:
