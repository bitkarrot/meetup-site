<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convert Npub to Hex format</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/nostr-tools@2.10.4/lib/nostr.bundle.js"></script>
    <script src="https://unpkg.com/nostr-login@latest/dist/unpkg.js" data-dark-mode="true" data-methods="extension,connect,readOnly" data-no-banner="true"></script>
</head>
<body class="bg-gradient-to-br from-purple-900 via-gray-900 to-black min-h-screen">
    <div class="container mx-auto px-4 py-12 max-w-2xl">
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-2xl p-8 border border-purple-500/20">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">Convert Npub to Hex format</h1>
                <p class="text-gray-400">Submit your Nostr npub to get a hex format</p>
            </div>

            <!-- Nostr Login Section -->
            <div id="loginSection" class="mb-6">
                <button 
                    type="button" 
                    id="nostrLoginBtn"
                    class="w-full py-3 px-6 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white font-semibold rounded-lg shadow-lg transform transition hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 focus:ring-offset-gray-900 flex items-center justify-center gap-2"
                >
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                    Login with Nostr
                </button>
                <p class="mt-2 text-xs text-gray-500 text-center">Or enter your details manually below</p>
            </div>

            <!-- Logged in user display (hidden by default) -->
            <div id="loggedInSection" class="hidden mb-6 p-4 bg-green-900/20 border border-green-500/30 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="text-green-300 text-sm">
                        <span class="font-medium">Logged in as:</span>
                        <span id="loggedInNpub" class="font-mono text-xs ml-2 break-all"></span>
                    </div>
                    <button 
                        type="button" 
                        id="logoutBtn"
                        class="text-xs text-gray-400 hover:text-white underline"
                    >
                        Logout
                    </button>
                </div>
            </div>

            <form id="nip05Form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-purple-300 mb-2">
                        Username
                    </label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        required
                        pattern="[a-z0-9_\-\.]+"
                        placeholder="yourname"
                        class="w-full px-4 py-3 bg-gray-900/50 border border-purple-500/30 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                    >
                    <p class="mt-1 text-xs text-gray-500">Lowercase letters, numbers, hyphens, underscores, and dots only</p>
                </div>

                <div>
                    <label for="pubkey" class="block text-sm font-medium text-purple-300 mb-2">
                        Nostr Public Key (npub or hex)
                    </label>
                    <input 
                        type="text" 
                        id="pubkey" 
                        name="pubkey" 
                        required
                        placeholder="npub1... or 64-character hex"
                        class="w-full px-4 py-3 bg-gray-900/50 border border-purple-500/30 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition font-mono text-sm"
                    >
                    <p class="mt-1 text-xs text-gray-500">Enter your npub (starts with npub1) or 64-character hex public key</p>
                </div>

                <div id="hexDisplay" class="hidden">
                    <label class="block text-sm font-medium text-green-400 mb-2">
                        Converted Hex Public Key
                    </label>
                    <div class="w-full px-4 py-3 bg-green-900/20 border border-green-500/30 rounded-lg text-green-300 font-mono text-sm break-all" id="hexOutput"></div>
                </div>

                <div id="errorMessage" class="hidden bg-red-900/30 border border-red-500/50 rounded-lg p-4 text-red-300 text-sm"></div>
                <div id="successMessage" class="hidden bg-green-900/30 border border-green-500/50 rounded-lg p-4 text-green-300 text-sm"></div>
            </form>
        </div>

        <p class="text-center text-gray-500 text-sm mt-6">
            Learn more about <a href="https://github.com/nostr-protocol/nips/blob/master/05.md" target="_blank" class="text-purple-400 hover:text-purple-300">NIP-05</a>
        </p>
    </div>

    <script>
        function isValidHex(str) {
            return /^[0-9a-fA-F]{64}$/.test(str);
        }

        function convertToHex(input) {
            input = input.trim();
            
            if (isValidHex(input)) {
                return input.toLowerCase();
            }
            
            if (input.startsWith('npub1')) {
                try {
                    const decoded = NostrTools.nip19.decode(input);
                    if (decoded.type !== 'npub') throw new Error('Not an npub');
                    return decoded.data;
                } catch (e) {
                    throw new Error('Invalid npub format: ' + e.message);
                }
            }
            
            throw new Error('Invalid public key. Must be npub1... or 64-character hex');
        }

        // Nostr Login Integration
        const loginSection = document.getElementById('loginSection');
        const loggedInSection = document.getElementById('loggedInSection');
        const loggedInNpub = document.getElementById('loggedInNpub');
        const nostrLoginBtn = document.getElementById('nostrLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const pubkeyInput = document.getElementById('pubkey');
        const usernameInput = document.getElementById('username');

        // Popular relays for fetching profiles
        const PROFILE_RELAYS = [
            'wss://purplepag.es',
            'wss://relay.damus.io',
            'wss://relay.primal.net',
            'wss://relay.nos.social'
        ];

        // Fetch user profile (kind 0) from relays
        async function fetchProfile(hexPubkey) {
            const filter = { kinds: [0], authors: [hexPubkey], limit: 1 };
            
            for (const relayUrl of PROFILE_RELAYS) {
                try {
                    const relay = await NostrTools.Relay.connect(relayUrl);
                    
                    const event = await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            relay.close();
                            reject(new Error('Timeout'));
                        }, 5000);
                        
                        const sub = relay.subscribe([filter], {
                            onevent(event) {
                                clearTimeout(timeout);
                                relay.close();
                                resolve(event);
                            },
                            oneose() {
                                clearTimeout(timeout);
                                relay.close();
                                resolve(null);
                            }
                        });
                    });
                    
                    if (event) {
                        const profile = JSON.parse(event.content);
                        return profile;
                    }
                } catch (err) {
                    console.log(`Failed to fetch from ${relayUrl}:`, err.message);
                }
            }
            return null;
        }

        // Sanitize username for NIP-05 (lowercase, allowed chars only)
        function sanitizeUsername(name) {
            if (!name) return '';
            return name.toLowerCase().replace(/[^a-z0-9_\.\-]/g, '').slice(0, 64);
        }

        // Handle nostr-login auth events
        document.addEventListener('nlAuth', async (e) => {
            if (e.detail.type === 'login' || e.detail.type === 'signup') {
                // User logged in - get their pubkey
                try {
                    const hexPubkey = await window.nostr.getPublicKey();
                    const npub = NostrTools.nip19.npubEncode(hexPubkey);
                    
                    // Update UI
                    loginSection.classList.add('hidden');
                    loggedInSection.classList.remove('hidden');
                    loggedInNpub.textContent = npub.slice(0, 20) + '...' + npub.slice(-8);
                    
                    // Fill the pubkey field
                    pubkeyInput.value = npub;
                    pubkeyInput.dispatchEvent(new Event('input'));
                    
                    // Try to fetch profile and auto-fill username
                    const profile = await fetchProfile(hexPubkey);
                    if (profile) {
                        const username = sanitizeUsername(profile.name || profile.display_name || '');
                        if (username) {
                            usernameInput.value = username;
                        }
                    }
                    
                    // Focus on username field
                    usernameInput.focus();
                } catch (err) {
                    console.error('Failed to get pubkey:', err);
                }
            } else if (e.detail.type === 'logout') {
                // User logged out
                loginSection.classList.remove('hidden');
                loggedInSection.classList.add('hidden');
                loggedInNpub.textContent = '';
                usernameInput.value = '';
            }
        });

        // Login button opens nostr-login modal
        nostrLoginBtn.addEventListener('click', () => {
            document.dispatchEvent(new CustomEvent('nlLaunch', { detail: 'welcome' }));
        });

        // Logout button
        logoutBtn.addEventListener('click', () => {
            document.dispatchEvent(new CustomEvent('nlLogout'));
            pubkeyInput.value = '';
            pubkeyInput.dispatchEvent(new Event('input'));
        });

        // Live conversion display
        const hexDisplay = document.getElementById('hexDisplay');
        const hexOutput = document.getElementById('hexOutput');

        pubkeyInput.addEventListener('input', () => {
            const value = pubkeyInput.value.trim();
            if (!value) {
                hexDisplay.classList.add('hidden');
                return;
            }
            
            try {
                const hex = convertToHex(value);
                hexOutput.textContent = hex;
                hexDisplay.classList.remove('hidden');
                pubkeyInput.classList.remove('border-red-500');
                pubkeyInput.classList.add('border-green-500');
            } catch (e) {
                hexDisplay.classList.add('hidden');
                if (value.length > 10) {
                    pubkeyInput.classList.add('border-red-500');
                    pubkeyInput.classList.remove('border-green-500');
                }
            }
        });

        // Form submission
        const form = document.getElementById('nip05Form');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const submitBtn = document.getElementById('submitBtn');

        const WORKER_URL = '/api/submit-nip05';

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const username = document.getElementById('username').value.trim().toLowerCase();
                const pubkeyRaw = document.getElementById('pubkey').value.trim();

                // Validate username
                if (!/^[a-z0-9_\-\.]+$/.test(username)) {
                    throw new Error('Username can only contain lowercase letters, numbers, hyphens, underscores, and dots');
                }

                // Validate pubkey format (will be converted server-side too)
                const hexPubkey = convertToHex(pubkeyRaw);

                // Submit to local API
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username,
                        pubkey: hexPubkey,
                    }),
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to submit request');
                }

                // Display success message with new API response format
                successMessage.innerHTML = `
                    <strong>Success!</strong> ${result.message}<br><br>
                    Your NIP-05 identifier is now: <code class="text-green-200">${result.nip05}</code><br><br>
                    You can verify it by visiting <a href="/public/.well-known/nostr.json" target="_blank" class="underline text-green-200 hover:text-white">
                        /public/.well-known/nostr.json
                    </a>
                `;
                successMessage.classList.remove('hidden');
                form.reset();
                hexDisplay.classList.add('hidden');

            } catch (error) {
                errorMessage.textContent = error.message;
                errorMessage.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Request';
            }
        });
    </script>
</body>
</html>
