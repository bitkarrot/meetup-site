services:
  relay:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: swarm_relay
    ports:
      - "${RELAY_PORT:-3334}:${RELAY_PORT:-3334}"
    environment:
      # Required
      RELAY_NAME: ${RELAY_NAME:-Swarm Relay}
      RELAY_PUBKEY: ${RELAY_PUBKEY:-8ad8f1f78c8e11966242e28a7ca15c936b23a999d5fb91bfe4e4472e2d6eaf55}
      RELAY_DESCRIPTION: ${RELAY_DESCRIPTION:-Team Nostr relay}
      
      # Database - using badger
      DB_ENGINE: badger
      DB_PATH: /app/db/
      
      # Optional domains (leave empty to use local public/.well-known/nostr.json)
      TEAM_DOMAIN: ${TEAM_DOMAIN:-}
      NPUB_DOMAIN: ${NPUB_DOMAIN:-}
      
      # Server
      RELAY_PORT: ${RELAY_PORT:-3334}
      
      # Blossom file storage
      BLOSSOM_ENABLED: ${BLOSSOM_ENABLED:-false}
      BLOSSOM_PATH: ${BLOSSOM_PATH:-blossom/}
      BLOSSOM_URL: ${BLOSSOM_URL:-http://localhost:3334}
      
      # WebSocket URL (for frontend)
      WEBSOCKET_URL: ${WEBSOCKET_URL:-ws://localhost:3334}
      
      # Kind filtering
      ALLOWED_KINDS: ${ALLOWED_KINDS:-}
      PUBLIC_ALLOWED_KINDS: ${PUBLIC_ALLOWED_KINDS:-}
      
      # Trusted client override
      TRUSTED_CLIENT_NAME: ${TRUSTED_CLIENT_NAME:-}
      TRUSTED_CLIENT_KINDS: ${TRUSTED_CLIENT_KINDS:-}
      
      # Upload limits
      MAX_UPLOAD_SIZE_MB: ${MAX_UPLOAD_SIZE_MB:-200}
      
      # Mirror endpoint (blank = disabled)
      ALLOWED_MIRROR_HOSTS: ${ALLOWED_MIRROR_HOSTS:-}
      
      # S3/Tigris Storage (optional - defaults to filesystem)
      STORAGE_BACKEND: ${STORAGE_BACKEND:-filesystem}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_BUCKET: ${S3_BUCKET:-}
      S3_REGION: ${S3_REGION:-auto}
      S3_PUBLIC_URL: ${S3_PUBLIC_URL:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
    volumes:
      - public_data:/app/public
      - badger_data:/app/db
      - blossom_data:/app/blossom
      - backup_data:/app/backups
    # Zeabur-specific labels for automatic volume creation
    labels:
      zeabur.service.name: "swarm-relay"
      zeabur.service.type: "docker"
      zeabur.service.port: "3334"
      zeabur.volume.badger_data.size: "1Gi"
      zeabur.volume.badger_data.type: "persistent"
      zeabur.volume.blossom_data.size: "10Gi"
      zeabur.volume.blossom_data.type: "persistent"
      zeabur.volume.backup_data.size: "5Gi"
      zeabur.volume.backup_data.type: "persistent"
      zeabur.volume.public_data.size: "1Gi"
      zeabur.volume.public_data.type: "persistent"

volumes:
  badger_data:
    labels:
      zeabur.volume.name: "swarm-db"
      zeabur.volume.mount-path: "/app/db"
      zeabur.volume.size: "1Gi"
      zeabur.volume.type: "persistent"
  blossom_data:
    labels:
      zeabur.volume.name: "swarm-blossom"
      zeabur.volume.mount-path: "/app/blossom"
      zeabur.volume.size: "10Gi"
      zeabur.volume.type: "persistent"
  backup_data:
    labels:
      zeabur.volume.name: "swarm-backups"
      zeabur.volume.mount-path: "/app/backups"
      zeabur.volume.size: "5Gi"
      zeabur.volume.type: "persistent"
  public_data:
    labels:
      zeabur.volume.name: "swarm-public"
      zeabur.volume.mount-path: "/app/public"
      zeabur.volume.size: "1Gi"
      zeabur.volume.type: "persistent"
