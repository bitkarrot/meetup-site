<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .header {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .header h1 {
        color: #4a5568;
        margin-bottom: 0.5rem;
    }

    .header p {
        color: #718096;
    }

    .logout-btn {
        padding: 0.5rem 1rem;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        background: white;
        padding: 0.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .tab {
        flex: 1;
        padding: 1rem;
        background: transparent;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        color: #718096;
        transition: all 0.3s ease;
    }

    .tab.active {
        background: #667eea;
        color: white;
    }

    .tab-content {
        display: none;
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .tab-content.active {
        display: block;
    }

    .user-list {
        margin-top: 1rem;
    }

    .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: #f7fafc;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        border-left: 4px solid #667eea;
    }

    .user-info {
        flex: 1;
    }

    .user-name {
        font-weight: 500;
        color: #2d3748;
        margin-bottom: 0.25rem;
    }

    .user-pubkey {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.8rem;
        color: #718096;
    }

    .user-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-small {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-edit {
        background: #3182ce;
        color: white;
    }

    .btn-delete {
        background: #e53e3e;
        color: white;
    }

    .btn-add {
        background: #38a169;
        color: white;
        margin-bottom: 1rem;
    }

    .add-user-form {
        display: none;
        background: #f7fafc;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
    }

    .env-list {
        margin-top: 1rem;
    }

    .env-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: #f7fafc;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        border-left: 4px solid #667eea;
    }

    .env-name {
        font-weight: 500;
        color: #2d3748;
    }

    .env-value {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        color: #718096;
        background: #2d3748;
        color: #e2e8f0;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }

    .resource-links {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .resource-card {
        background: #f7fafc;
        padding: 1.5rem;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        text-align: center;
    }

    .resource-title {
        font-weight: 500;
        color: #2d3748;
        margin-bottom: 0.5rem;
    }

    .resource-description {
        color: #718096;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .resource-link {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: #667eea;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 0.9rem;
    }

    .resource-link:hover {
        background: #5a67d8;
    }

    @media (max-width: 768px) {
        .header-content {
            flex-direction: column;
            text-align: center;
        }

        .tabs {
            flex-direction: column;
        }

        .form-row {
            flex-direction: column;
        }

        .resource-links {
            grid-template-columns: 1fr;
        }
    }
</style>
<div class="container">
    <div class="header">
        <div class="header-content">
            <div>
                <h1 id="relayName">Loading...</h1>
                <p id="relayDescription">Loading...</p>
                <p id="userGreeting" style="margin-top: 0.5rem; font-weight: 500; color: #667eea;"></p>
            </div>
            <button id="logoutBtn" class="logout-btn">Logout</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" data-tab="users">üë• Users</button>
        <button class="tab" data-tab="environment">‚öôÔ∏è Environment</button>
        <button class="tab" data-tab="resources">üîó Resources</button>
    </div>

    <!-- Users Tab -->
    <div id="usersTab" class="tab-content active">
        <h2>üë• Users Management</h2>
        <button id="addUserBtn" class="btn btn-add">+ Add User</button>
        
        <div id="addUserForm" class="add-user-form">
            <h3>Add New User</h3>
            <form id="newUserForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="newUserName">Name</label>
                        <input type="text" id="newUserName" required>
                    </div>
                    <div class="form-group">
                        <label for="newUserPubkey">Pubkey (hex or npub)</label>
                        <input type="text" id="newUserPubkey" required placeholder="hex or npub...">
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button type="submit" class="btn btn-small" style="background: #38a169;">Add</button>
                    <button type="button" id="cancelAddUser" class="btn btn-small" style="background: #718096;">Cancel</button>
                </div>
            </form>
        </div>

        <div id="userList" class="user-list">
            <!-- Users will be loaded here -->
        </div>
    </div>

    <!-- Environment Tab -->
    <div id="environmentTab" class="tab-content">
        <h2>‚öôÔ∏è Environment Variables</h2>
        <p>Current environment configuration:</p>
        <div id="envList" class="env-list">
            <!-- Environment variables will be loaded here -->
        </div>
        <p style="margin-top: 2rem;">
            <a href="https://github.com/HiveTalk/swarm/blob/zeabur-dashboard/ENV_CONFIG_GUIDE.md" target="_blank" style="color: #667eea;">
                üìñ View Environment Configuration Guide
            </a>
        </p>
    </div>

    <!-- Resources Tab -->
    <div id="resourcesTab" class="tab-content">
        <h2>üîó Resources</h2>
        <div class="resource-links">
            <div class="resource-card">
                <div class="resource-title">üé® Curator</div>
                <div class="resource-description">
                    Simple interface to quickly lookup any kind on a relay. Login to switch relays, view json, post kind 1 and delete notes.
                </div>
                <a href="https://curator.hivetalk.org" target="_blank" class="resource-link">Launch Curator</a>
            </div>
            <div class="resource-card">
                <div class="resource-title">üîç Nostrdebug</div>
                <div class="resource-description">
                    Debug and explore Nostr events, relays, and network activity.
                </div>
                <a href="https://nostrdebug.com" target="_blank" class="resource-link">Launch Nostrdebug</a>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        // Initialize dashboard UI
        const dashboard = document.getElementById('dashboard');
        
        // Update header
        document.getElementById('relayName').textContent = currentData.relayName;
        document.getElementById('relayDescription').textContent = currentData.relayDescription;
        
        // Find username for greeting
        let username = '';
        let hasAdminEntry = false;
        
        if (currentData.users) {
            for (const [name, pk] of Object.entries(currentData.users)) {
                if (name.toLowerCase() === 'admin' || name === '_') {
                    hasAdminEntry = true;
                }
                if (pk === currentUserPubkey) {
                    username = name;
                }
            }
        }
        
        const greetingElem = document.getElementById('userGreeting');
        if (hasAdminEntry && (username.toLowerCase() === 'admin' || username === '_')) {
            greetingElem.textContent = `Hello Admin!`;
        } else {
            // If no Admin entry exists, show pubkey in parentheses
            greetingElem.textContent = `Hello Admin (${currentUserPubkey.substring(0, 8)}...)!`;
        }

        // Utility functions for pubkey display (using nostr-tools)
        function hexToNpub(hex) {
            try {
                return NostrTools.nip19.npubEncode(hex);
            } catch (err) {
                console.error('Error converting hex to npub:', err);
                return null;
            }
        }

        function npubToHex(npub) {
            try {
                const decoded = NostrTools.nip19.decode(npub);
                if (decoded.type !== 'npub') {
                    throw new Error('Not an npub');
                }
                return decoded.data;
            } catch (err) {
                console.error('Error converting npub to hex:', err);
                return null;
            }
        }
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (window.nostrLogin) {
                document.dispatchEvent(new CustomEvent('nlLogout'));
            }
            try {
                await fetch('/api/dashboard/logout');
            } catch (err) {
                console.error('Logout failed:', err);
            }
            localStorage.clear();
            sessionStorage.clear();
            currentUserPubkey = '';
            window.location.reload();
        });

        // Tab switching
        dashboard.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                dashboard.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                dashboard.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        // Users management
        async function loadUsers() {
            try {
                const response = await fetch('/api/dashboard/users');
                const data = await response.json();
                currentData.users = data.users;
                currentData.isRemote = data.isRemote;
                renderUsers();
            } catch (err) {
                console.error('Failed to load users:', err);
            }
        }

        function renderUsers() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            const statusDiv = document.createElement('div');
            statusDiv.className = 'user-item';
            statusDiv.style.background = '#f0f4f8';
            statusDiv.style.borderLeftColor = '#718096';
            
            if (currentData.isRemote) {
                const domain = currentData.npubDomain || '';
                const wellKnownUrl = `https://${domain}/.well-known/nostr.json`;
                const publicWellKnownUrl = `https://${domain}/public/.well-known/nostr.json`;
                
                statusDiv.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">üìç Remote Mode</div>
                        <div class="user-pubkey">
                            Fetching from: ${domain}<br>
                            <small>
                                <a href="${wellKnownUrl}" target="_blank" style="color: #667eea;">View nostr.json</a> | 
                                <a href="${publicWellKnownUrl}" target="_blank" style="color: #667eea;">View public nostr.json</a>
                            </small>
                        </div>
                    </div>
                `;
                userList.appendChild(statusDiv);
            } else {
                statusDiv.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">üìÅ Local Mode</div>
                        <div class="user-pubkey">Using local public/.well-known/nostr.json</div>
                    </div>
                `;
                userList.appendChild(statusDiv);
            }

            if (currentData.users && Object.keys(currentData.users).length > 0) {
                Object.entries(currentData.users).forEach(([name, pubkey]) => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    const npub = hexToNpub(pubkey);
                    const profileUrl = `https://nostr.at/${npub}`;
                    
                    userItem.innerHTML = `
                        <div class="user-info">
                            <div class="user-name">${name}</div>
                            <div class="user-pubkey">
                                <a href="${profileUrl}" target="_blank">${npub}</a>
                            </div>
                        </div>
                        <div class="user-actions">
                            ${!currentData.isRemote ? `
                                <button class="btn-small btn-edit" onclick="editUser('${name}', '${pubkey}')">Edit</button>
                                <button class="btn-small btn-delete" onclick="deleteUser('${pubkey}')">Delete</button>
                            ` : '<span style="color: #718096; font-size: 0.8rem;">Read-only</span>'}
                        </div>
                    `;
                    userList.appendChild(userItem);
                });
            }
        }

        document.getElementById('addUserBtn').addEventListener('click', () => {
            if (currentData.isRemote) {
                alert('Cannot add users when using remote nostr.json');
                return;
            }
            document.getElementById('addUserForm').style.display = 'block';
        });

        document.getElementById('cancelAddUser').addEventListener('click', () => {
            document.getElementById('addUserForm').style.display = 'none';
            document.getElementById('newUserForm').reset();
        });

        document.getElementById('newUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('newUserName').value.trim();
            let pubkey = document.getElementById('newUserPubkey').value.trim();
            if (pubkey.startsWith('npub1')) {
                pubkey = npubToHex(pubkey);
                if (!pubkey) { alert('Invalid npub format'); return; }
            }
            try {
                const response = await fetch('/api/dashboard/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, pubkey })
                });
                if (response.ok) {
                    document.getElementById('addUserForm').style.display = 'none';
                    document.getElementById('newUserForm').reset();
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to add user'));
                }
            } catch (err) { alert('Network error: ' + err.message); }
        });

        // Environment variables
        async function loadEnvironment() {
            try {
                const response = await fetch('/api/dashboard/environment');
                const data = await response.json();
                currentData.environment = data.environment;
                renderEnvironment();
            } catch (err) {
                console.error('Failed to load environment:', err);
            }
        }

        function renderEnvironment() {
            const envList = document.getElementById('envList');
            envList.innerHTML = '';
            Object.entries(currentData.environment).forEach(([name, value]) => {
                const envItem = document.createElement('div');
                envItem.className = 'env-item';
                const displayValue = value || '<em>(not set)</em>';
                envItem.innerHTML = `
                    <div class="env-name">${name}</div>
                    <div class="env-value">${displayValue}</div>
                `;
                envList.appendChild(envItem);
            });
        }

        // Exposed global functions for onclick handlers
        window.editUser = async function(name, pubkey) {
            const newName = prompt('Edit name:', name);
            if (newName && newName !== name) {
                try {
                    const response = await fetch(`/api/dashboard/user/${pubkey}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName })
                    });
                    if (response.ok) loadUsers();
                    else alert('Error: Failed to update user');
                } catch (err) { alert('Network error: ' + err.message); }
            }
        };

        window.deleteUser = async function(pubkey) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            try {
                const response = await fetch(`/api/dashboard/user/${pubkey}`, { method: 'DELETE' });
                if (response.ok) loadUsers();
                else alert('Error: Failed to delete user');
            } catch (err) { alert('Network error: ' + err.message); }
        };

        // Initial load
        loadUsers();
        loadEnvironment();
    })();
</script>
